<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>BibInject - Bibliography Injection Tool</title>
    <link rel="stylesheet" href="static/web.css" />
    <link
      rel="shortcut icon"
      href="/static/icons/icon.ico"
      type="image/x-icon"
    />
  </head>

  <script>
    // Utility to display filename next to input
    function updateFileNameDisplay(input, displayElem) {
      if (input.files.length > 0) {
        displayElem.textContent = input.files[0].name;
      } else {
        displayElem.textContent = "";
      }
    }

    // Utility to load text file content into a textarea
    function loadFileIntoTextarea(input, textarea) {
      if (input.files.length === 0) return;
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        textarea.value = e.target.result;
      };
      reader.readAsText(file);
    }

    // Utility to preview uploaded image
    function previewImage(input, imgElem) {
      if (input.files.length === 0) {
        imgElem.src = "";
        imgElem.style.display = "none";
        return;
      }
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        imgElem.src = e.target.result;
        imgElem.style.display = "inline-block";
      };
      reader.readAsDataURL(file);
    }

    document.addEventListener("DOMContentLoaded", function () {
      // HTML file input
      const htmlFileInput = document.querySelector('input[name="htmlfile"]');
      const htmlTextarea = document.getElementById("htmltext");
      // Where to display file name for HTML file
      let htmlFileNameDisplay = document.createElement("div");
      htmlFileInput.parentNode.appendChild(htmlFileNameDisplay);
      htmlFileNameDisplay.style.marginTop = "6px";
      htmlFileNameDisplay.style.fontSize = "0.9em";
      htmlFileNameDisplay.style.color = "var(--color-text-secondary)";

      htmlFileInput.addEventListener("change", function () {
        updateFileNameDisplay(htmlFileInput, htmlFileNameDisplay);
        loadFileIntoTextarea(htmlFileInput, htmlTextarea);
      });

      // BibTeX file input
      const bibFileInput = document.querySelector('input[name="bibfile"]');
      const bibTextarea = document.getElementById("bibtext");
      // Where to display file name for BibTeX file
      let bibFileNameDisplay = document.createElement("div");
      bibFileInput.parentNode.appendChild(bibFileNameDisplay);
      bibFileNameDisplay.style.marginTop = "6px";
      bibFileNameDisplay.style.fontSize = "0.9em";
      bibFileNameDisplay.style.color = "var(--color-text-secondary)";

      bibFileInput.addEventListener("change", function () {
        updateFileNameDisplay(bibFileInput, bibFileNameDisplay);
        loadFileIntoTextarea(bibFileInput, bibTextarea);
      });

      const doiFileInput = document.querySelector('input[name="doifile"]');

      // Create a wrapper div to center the image
      let doiPreviewWrapper = document.createElement("div");
      doiPreviewWrapper.style.display = "flex";
      doiPreviewWrapper.style.justifyContent = "center";
      doiPreviewWrapper.style.marginTop = "8px";

      // Create the img element
      let doiPreviewImg = document.createElement("img");
      doiPreviewImg.style.maxWidth = "50px";
      doiPreviewImg.style.maxHeight = "50px";
      doiPreviewImg.style.display = "none";

      // Append img inside the wrapper div
      doiPreviewWrapper.appendChild(doiPreviewImg);

      // Append the wrapper div to the file input's parent
      doiFileInput.parentNode.appendChild(doiPreviewWrapper);

      doiFileInput.addEventListener("change", function () {
        previewImage(doiFileInput, doiPreviewImg);
      });
    });
  </script>

  <body>
    <div class="container">
      <header class="header">
        <div class="logo">
          <img
            src="../static/icons/logo1.2.svg"
            alt="BibInject Logo"
            class="logo-icon"
          />
          <h1>BibInject</h1>
        </div>
        <p class="tagline">Inject BibTeX into your HTML pages</p>
      </header>

      <form
        action="/inject"
        method="post"
        enctype="multipart/form-data"
        class="main-form"
      >
        <!-- Step 1: Input Files -->
        <section class="form-section">
          <div class="section-header">
            <div class="step-badge">
              <span class="step-number">01</span>
            </div>
            <div class="section-title-group">
              <h2 class="section-title">Input Files</h2>
              <p class="section-description">
                Upload or paste your HTML and BibTeX files
              </p>
            </div>
          </div>

          <div class="dual-input-grid">
            <div class="input-card">
              <div class="card-header">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14 2v6h6M16 13H8M16 17H8M10 9H8"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <h3>HTML Document</h3>
              </div>

              <div class="file-upload-wrapper">
                <label class="file-upload-button">
                  <input type="file" name="htmlfile" accept=".html,.htm" />
                  <span class="upload-text">Choose HTML file</span>
                </label>
              </div>

              <div class="divider">
                <span>or</span>
              </div>

              <div class="textarea-wrapper">
                <label for="htmltext" class="textarea-label"
                  >Paste HTML content</label
                >
                <textarea
                  id="htmltext"
                  name="htmltext"
                  rows="6"
                  placeholder="<!DOCTYPE html>&#10;<html>&#10;  <head>...</head>&#10;  <body>...</body>&#10;</html>"
                ></textarea>
              </div>
            </div>

            <div class="input-card">
              <div class="card-header">
                <svg class="icon" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M14 2v6h6"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <h3>BibTeX File</h3>
              </div>

              <div class="file-upload-wrapper">
                <label class="file-upload-button">
                  <input type="file" name="bibfile" accept=".bib" />
                  <span class="upload-text">Choose .bib file</span>
                </label>
              </div>

              <div class="divider">
                <span>or</span>
              </div>

              <div class="textarea-wrapper">
                <label for="bibtext" class="textarea-label"
                  >Paste BibTeX content</label
                >
                <textarea
                  id="bibtext"
                  name="bibtext"
                  rows="6"
                  placeholder="@article{key,&#10;  author = {Author Name},&#10;  title = {Title},&#10;  year = {2024}&#10;}"
                ></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- Step 2: Target Configuration -->
        <section class="form-section">
          <div class="section-header">
            <div class="step-badge">
              <span class="step-number">02</span>
            </div>
            <div class="section-title-group">
              <h2 class="section-title">Target Configuration</h2>
              <p class="section-description">
                Specify where to inject your references
              </p>
            </div>
          </div>

          <div class="input-card single">
            <label for="target_id" class="input-label">
              <svg class="icon-small" viewBox="0 0 24 24" fill="none">
                <circle
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle cx="12" cy="12" r="3" fill="currentColor" />
              </svg>
              Target HTML Element ID
            </label>
            <input
              type="text"
              id="target_id"
              name="target_id"
              placeholder="e.g., references, bibliography, citations"
              class="text-input"
            />
            <p class="input-hint">
              Enter the ID attribute of the HTML element where references will
              be inserted
            </p>
          </div>
        </section>

        <!-- Step 3: Style Parameters -->
        <section class="form-section">
          <div class="section-header">
            <div class="step-badge">
              <span class="step-number">03</span>
            </div>
            <div class="section-title-group">
              <h2 class="section-title">Style Parameters</h2>
              <p class="section-description">
                Customize the appearance and organization
              </p>
            </div>
          </div>

          <div class="parameters-grid">
            <div class="select-card">
              <label for="style" class="select-label">
                <svg class="icon-small" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M12 2L2 7l10 5 10-5-10-5z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M2 17l10 5 10-5M2 12l10 5 10-5"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                Citation Style
              </label>
              <select id="style" name="style" class="select-input">
                {% for style in data.styles %}
                <option value="{{ style }}">{{ style }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="select-card">
              <label for="order" class="select-label">
                <svg class="icon-small" viewBox="0 0 24 24" fill="none">
                  <path
                    d="M3 6h18M3 12h18M3 18h18"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                  />
                </svg>
                Sort Order
              </label>
              <select id="order" name="order" class="select-input">
                <option value="">None</option>
                {% for opt in data.order_options %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="select-card">
              <label for="group" class="select-label">
                <svg class="icon-small" viewBox="0 0 24 24" fill="none">
                  <rect
                    x="3"
                    y="3"
                    width="7"
                    height="7"
                    stroke="currentColor"
                    stroke-width="2"
                    rx="1"
                  />
                  <rect
                    x="14"
                    y="3"
                    width="7"
                    height="7"
                    stroke="currentColor"
                    stroke-width="2"
                    rx="1"
                  />
                  <rect
                    x="3"
                    y="14"
                    width="7"
                    height="7"
                    stroke="currentColor"
                    stroke-width="2"
                    rx="1"
                  />
                  <rect
                    x="14"
                    y="14"
                    width="7"
                    height="7"
                    stroke="currentColor"
                    stroke-width="2"
                    rx="1"
                  />
                </svg>
                Group By
              </label>
              <select id="group" name="group" class="select-input">
                <option value="">None</option>
                {% for opt in data.group_options %}
                <option value="{{ opt }}">{{ opt }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="select-card optional">
              <label for="doifile" class="select-label">
                <svg class="icon-small" viewBox="0 0 24 24" fill="none">
                  <rect
                    x="3"
                    y="3"
                    width="18"
                    height="18"
                    rx="2"
                    stroke="currentColor"
                    stroke-width="2"
                  />
                  <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor" />
                  <path
                    d="M21 15l-5-5L5 21"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                DOI Icon
                <span class="optional-badge">Optional</span>
              </label>
              <label class="file-upload-button secondary">
                <input type="file" name="doifile" accept="image/*" />
                <span class="upload-text">Upload icon</span>
              </label>
            </div>
          </div>
        </section>

        <!-- Submit Button -->
        <div class="submit-section">
          <button
            type="submit"
            class="submit-button"
            formaction="/inject#output-section"
          >
            <svg class="button-icon" viewBox="0 0 24 24" fill="none">
              <path
                d="M21 12H3M21 12L16 7M21 12L16 17"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            Inject References
          </button>
        </div>
      </form>

      <!-- Output Section -->
      {% if output %}
      <div class="output-container" id="output-section">
        <div class="output-header">
          <div class="output-title-group">
            <div class="step-badge">
              <svg
                class="icon-big step-number"
                version="1.1"
                id="Layer_1"
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                width="800px"
                height="800px"
                viewBox="0 0 92 92"
                enable-background="new 0 0 92 92"
                xml:space="preserve"
              >
                <path
                  fill="currentColor"
                  id="XMLID_1239_"
                  d="M91.3,43.8C90.6,42.8,74.4,19,46,19C17.6,19,1.4,42.8,0.7,43.8c-0.9,1.3-0.9,3.1,0,4.5
	C1.4,49.2,17.6,73,46,73c28.4,0,44.6-23.8,45.3-24.8C92.2,46.9,92.2,45.1,91.3,43.8z M46,65C26.7,65,13.5,51.4,9,46
	c4.5-5.5,17.6-19,37-19c19.3,0,32.5,13.6,37,19C78.4,51.5,65.3,65,46,65z M48.3,29.6c-4.4-0.6-8.7,0.5-12.3,3.2c0,0,0,0,0,0
	c-7.3,5.5-8.8,15.9-3.3,23.2c2.7,3.6,6.5,5.8,10.9,6.5c0.8,0.1,1.6,0.2,2.3,0.2c3.6,0,7-1.2,9.9-3.3c7.3-5.5,8.8-15.9,3.3-23.2
	C56.6,32.5,52.7,30.2,48.3,29.6z M52.3,54.5c-2.2,1.7-5,2.4-7.8,2c-2.8-0.4-5.3-1.9-7-4.1C34.1,47.7,35,41,39.7,37.5
	c2.2-1.7,5-2.4,7.8-2c2.8,0.4,5.3,1.9,7,4.1C57.9,44.3,57,51,52.3,54.5z M51.9,40c0.8,0.7,1.2,1.8,1.2,2.8c0,1-0.4,2.1-1.2,2.8
	c-0.7,0.7-1.8,1.2-2.8,1.2c-1.1,0-2.1-0.4-2.8-1.2c-0.8-0.8-1.2-1.8-1.2-2.8c0-1.1,0.4-2.1,1.2-2.8c0.7-0.8,1.8-1.2,2.8-1.2
	C50.2,38.9,51.2,39.3,51.9,40z"
                />
              </svg>
            </div>
            <h2>Generated Output</h2>
          </div>

          <form action="/download" method="post" class="download-form">
            <textarea name="output" style="display: none">
{{ output }}</textarea
            >
            <button type="submit" class="download-button">
              <svg class="button-icon" viewBox="0 0 24 24" fill="none">
                <path
                  d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Download HTML
            </button>
          </form>
        </div>

        <div class="preview-container">
          <div class="preview-label">Live Preview</div>
          <iframe id="viewer-frame" src="/preview"></iframe>
        </div>
      </div>
      {% endif %}

      <footer class="footer">
        <p>BibInject © 2025 · Inject BibTeX into your HTML pages</p>
      </footer>
    </div>
  </body>
</html>
